<html>
<head>
  <style>
    line {
      stroke: rgb(255, 255, 255);
    }
    .map-fill, .map-crop {
      width: 960px;
      height: 600px;
      position: absolute;
      top: 8px;
      left: 8px;
    }
    .map-crop {
      background: url('map.png') no-repeat;
    }
    .map-fill {
      background: url('map-fill.png') no-repeat;
      z-index: -10;
    }
  </style>
</head>
<body>

<div class="map-fill"></div>
<svg width="960" height="600">
  <g id="traces"></g>
</svg>
<div class="map-crop"></div>

<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
<script src="https://d3js.org/d3.v5.min.js"></script>
<script src="https://d3js.org/topojson.v2.min.js"></script>
<!--<script src="https://ssvg.surge.sh/ssvg.js"></script>-->
<script src="https://measure-fps.surge.sh/measureFPS.js"></script>
<script src="data-processing.js"></script>
<script src="wind-data-feb-21-2019.js"></script>
<script>

  fpsLog = []

  const lastTenFramesTimes2 = [];
  const isCanvas2 = document.getElementsByTagName("canvas").length;

  const performanceMeasureRAF2 = () => {

    if(!isCanvas2) {
      lastTenFramesTimes2.push(Date.now());

      if(lastTenFramesTimes2.length > 100) {
        lastTenFramesTimes2.shift(); // Remove first item
      }

      if(lastTenFramesTimes2.length > 1) {
        const timeForTenDrawsMs = Date.now() - lastTenFramesTimes2[0];
        const fps = Math.round(lastTenFramesTimes2.length / timeForTenDrawsMs * 1000);
        fpsLog.push(fps);
        //frontLog.push(fps);
      }
    }


    requestAnimationFrame(performanceMeasureRAF2);
  };

  performanceMeasureRAF2();

  setTimeout(
          function(){
            fpsAvg = 0;

            for (i=0; i <100; i++){
              fpsLog.shift();

            }
            for (i=0; i<fpsLog.length; i++){
              fpsAvg += fpsLog[i];
            }

            console.log('FPS Log', fpsLog);
            console.log('FPS Avg', fpsAvg/fpsLog.length)

          }, 30000);

  const svg = d3.select("svg");
  //const mapG = svg.select('#map');
  const tracesG = svg.select('#traces');
  const projection = d3.geoAlbersUsa();
  const path = d3.geoPath()
          .projection(projection);


    const data = getParsedData(windData);

  let pathDs = [];
  const numberOfSegments = 4;
  let segmentLength = 12;
  for (let i = 0; i < Math.random() * 1000000; i++) {
    pathDs.push(createPath(projection, data));
  }
  let numberRafs = 0;
  const raf = () => {
    numberRafs++;
    if(numberRafs > 50) {
      for (let i = 0; i < Math.random() * 120; i++) {
        pathDs.push(createPath(projection, data));
      }
    }
    pathDs = pathDs.filter(p => p.progressPercent < 300);
    const segmentData = [];
    for(let d of pathDs) {
      const guideLength = d.length;
      if (!guideLength) {
        continue;
      }
      d.progressPercent += 1.1; // Move 0.4%  of the guide length per frame.
      const progressLength = d.progressPercent * guideLength / 100;
      for (let i = 0; i < numberOfSegments; i++) {
        let startDistance = progressLength + segmentLength * (i - numberOfSegments);
        let endDistance = progressLength + segmentLength * (i - numberOfSegments + 1);
        startDistance = startDistance < 0 ? 0 : startDistance;
        endDistance = endDistance < 0 ? 0 : endDistance;
        startDistance = startDistance > guideLength ? guideLength : startDistance;
        endDistance = endDistance > guideLength ? guideLength : endDistance;
        segmentData.push({
          start: getPointAtLength(d, startDistance),
          end: getPointAtLength(d, endDistance),
          index: i
        });
      }
    }
    const segmentLines = tracesG
            .selectAll('line')
            .data(segmentData);
    const pathsEnter = segmentLines.enter()
            .append('line')
            .attr('opacity', (d) => (d.index + 1) / (numberOfSegments + 2));
    pathsEnter.merge(segmentLines)
            .attr('x1', d => d.start.x)
            .attr('y1', d => d.start.y)
            .attr('x2', d => d.end.x)
            .attr('y2', d => d.end.y);
    requestAnimationFrame(raf);
  };
  raf();

</script>

</body>
</html>
